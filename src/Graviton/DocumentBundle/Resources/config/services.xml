<?xml version="1.0" encoding="UTF-8"?>
<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">
    <parameters>
        <parameter key="graviton.document.service.extrefconverter.class">Graviton\DocumentBundle\Service\ExtReferenceConverter</parameter>
        <parameter key="graviton.document.service.collectioncache.class">Graviton\DocumentBundle\Service\CollectionCache</parameter>
        <parameter key="graviton.document.listener.extreferencesearchlistener.class">Graviton\DocumentBundle\Listener\ExtReferenceSearchListener</parameter>
        <parameter key="graviton.document.listener.fieldnamesearchlistener.class">Graviton\DocumentBundle\Listener\FieldNameSearchListener</parameter>
        <parameter key="graviton.document.listener.documentversionlistener.class">Graviton\DocumentBundle\Listener\DocumentVersionListener</parameter>
        <parameter key="graviton.document.serializer.handler.hash.class">Graviton\DocumentBundle\Serializer\Handler\HashHandler</parameter>
        <parameter key="graviton.document.serializer.handler.extref.class">Graviton\DocumentBundle\Serializer\Handler\ExtReferenceHandler</parameter>
        <parameter key="graviton.document.serializer.handler.date.class">Graviton\DocumentBundle\Serializer\Handler\DateHandler</parameter>
        <parameter key="graviton.document.serializer.handler.empty.class">Graviton\DocumentBundle\Serializer\Handler\EmptyHandler</parameter>
        <parameter key="graviton.document.serializer.listener.emptyextref.class">Graviton\DocumentBundle\Serializer\Listener\EmptyExtRefListener</parameter>
    </parameters>
    <services>
        <!-- extref converter -->
        <service id="graviton.document.service.extrefconverter" class="%graviton.document.service.extrefconverter.class%">
            <argument type="service" id="router"/>
            <argument>%graviton.document.type.extref.mapping%</argument>
        </service>

        <!-- Collection Cache Service -->
        <service id="graviton.document.service.collectioncache" class="%graviton.document.service.collectioncache.class%">
            <argument type="expression">service(parameter('graviton.cache.provider.service_id'))</argument>
            <argument>%graviton.cache.collections%</argument>
        </service>

        <!-- empty extref serializing listener -->
        <service id="graviton.document.serializer.listener.emptyextref" class="%graviton.document.serializer.listener.emptyextref.class%">
            <tag name="jms_serializer.event_listener" event="serializer.pre_serialize" method="onPreSerialize" direction="serialization"/>
        </service>

        <!-- Version listener -->
        <service id="graviton.document.listener.documentversion" class="%graviton.document.listener.documentversionlistener.class%">
            <argument type="service" id="doctrine_mongodb.odm.default_document_manager" />
            <argument type="service" id="graviton.schema.constraint.versionservice"/>
            <tag name="kernel.event_listener" event="document.model.event.insert" method="modelInsert"/>
            <tag name="kernel.event_listener" event="document.model.event.update" method="modelUpdate"/>
        </service>

        <!-- empty serializer handler -->
        <service id="graviton.document.serializer.handler.empty" class="%graviton.document.serializer.handler.empty.class%">
            <tag name="jms_serializer.handler" type="Empty" format="json"/>
        </service>

        <service id="graviton.document.listener.extreferencesearchlistener" class="%graviton.document.listener.extreferencesearchlistener.class%">
             <argument type="service" id="graviton.document.service.extrefconverter" />
             <argument>%graviton.document.extref.fields%</argument>
             <argument type="service" id="request_stack"/>
             <tag name="kernel.event_listener" event="rql.visit.node" method="onVisitNode" priority="2"/>
        </service>
        <service id="graviton.document.listener.fieldnamesearchlistener" class="%graviton.document.listener.fieldnamesearchlistener.class%">
            <argument>%graviton.document.rql.fields%</argument>
            <argument type="service" id="request_stack"/>
            <tag name="kernel.event_listener" event="rql.visit.node" method="onVisitNode" priority="1"/>
        </service>

        <!-- hash serializer handler -->
        <service id="graviton.document.serializer.handler.hash" class="%graviton.document.serializer.handler.hash.class%">
            <tag name="jms_serializer.handler"
                 type="Graviton\DocumentBundle\Entity\Hash"
                 format="json"/>
        </service>
        <!-- extref serializer & json schema validation handler -->
        <service id="graviton.document.serializer.handler.extref" class="%graviton.document.serializer.handler.extref.class%">
            <argument type="service" id="graviton.document.service.extrefconverter"/>
            <tag name="jms_serializer.handler"
                 type="Graviton\DocumentBundle\Entity\ExtReference"
                 format="json"/>
            <tag name="kernel.event_listener" event="graviton.json_schema.constraint.format" method="validateExtRef"/>
        </service>
        <!-- extref serializer handler -->
        <service id="graviton.document.serializer.handler.date" class="%graviton.document.serializer.handler.date.class%">
            <tag name="jms_serializer.subscribing_handler"
                 type="DateTime"
                 format="json"/>
        </service>
    </services>
</container>
